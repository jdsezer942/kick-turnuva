<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ramazan Ã–zel Quiz - Yemek TurnuvasÄ±</title>
  <style>body{background:#111;color:#fff;text-align:center;padding:20px;font-family:Arial;}button{background:#00ff00;color:black;padding:20px 40px;font-size:22px;border:none;border-radius:12px;cursor:pointer;margin:30px;}.option{border:3px solid #00ff00;padding:20px;margin:15px;border-radius:10px;cursor:pointer;font-size:20px;}</style>
</head>
<body>

<h1>ğŸ² Ramazan Ã–zel Yemek TurnuvasÄ±</h1>

<div id="login" style="display:block;">
  <button onclick="loginWithKick()">KICK Ä°LE GÄ°RÄ°Å YAP VE BAÅLA</button>
</div>

<div id="game" style="display:none;">
  <h2 id="title">Turnuva BaÅŸlÄ±yor...</h2>
  <div style="display:flex;justify-content:center;gap:40px;">
    <div id="opt1" class="option" onclick="choose(0)"></div>
    <div style="font-size:30px;font-weight:bold;">VS</div>
    <div id="opt2" class="option" onclick="choose(1)"></div>
  </div>
  <p id="info"></p>
</div>

<script>
// AYARLAR - SECRET'Ä° BURAYA KOYMADIK (PKCE ile gerek olmayabilir, test et)
const CLIENT_ID = "01KHSMYKTDM9DD6Y4HHBV0RYSB";
const REDIRECT_URI = window.location.origin + "/callback.html"; // otomatik aynÄ± domain

let items = ["Adana Kebap","Ä°skender","Lahmacun","MantÄ±","DÃ¶ner","Kumpir","Baklava","Sarma","Dolma","Pide","Pizza","Hamburger","Kebap","Ã‡iÄŸ KÃ¶fte","Menemen","Simit","BÃ¶rek","KÃ¼nefe","SÃ¼tlaÃ§","Kazandibi"];

let current = [], next = [], idx = 0;

// Token varsa oyunu baÅŸlat
if (localStorage.getItem('kick_token')) {
  document.getElementById('login').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  startGame();
}

// URL'de code var mÄ±? (callback'ten dÃ¶nÃ¼nce)
const params = new URLSearchParams(location.search);
const code = params.get('code');
if (code) {
  getToken(code);
}

function loginWithKick() {
  const state = Math.random().toString(36).substring(2);
  localStorage.setItem('state', state);

  const verifier = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(32)))).replace(/[^a-zA-Z0-9]/g,'');
  localStorage.setItem('verifier', verifier);

  crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier)).then(h => {
    const challenge = btoa(String.fromCharCode(...new Uint8Array(h))).replace(/[^a-zA-Z0-9]/g,'');

    const p = new URLSearchParams({
      client_id: CLIENT_ID,
      redirect_uri: REDIRECT_URI,
      response_type: 'code',
      scope: 'user:read channel:read',
      state: state,
      code_challenge_method: 'S256',
      code_challenge: challenge
    });

    location.href = `https://id.kick.com/oauth/authorize?${p}`;
  });
}

async function getToken(code) {
  const verifier = localStorage.getItem('verifier');
  const state = params.get('state');

  if (state !== localStorage.getItem('state')) {
    alert('GÃ¼venlik hatasÄ±!');
    location.href = '/';
    return;
  }

  try {
    const res = await fetch('https://id.kick.com/oauth/token', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        grant_type: 'authorization_code',
        client_id: CLIENT_ID,
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier: verifier
        // client_secret'i ekleme - PKCE ile gerekmeyebilir, hata verirse Kick panelden al ve ekle
      })
    });

    const data = await res.json();
    if (data.access_token) {
      localStorage.setItem('kick_token', data.access_token);
      location.href = '/'; // ana sayfaya dÃ¶n
    } else {
      alert('Token alÄ±namadÄ±: ' + (data.error || 'Hata'));
    }
  } catch(e) {
    alert('Hata: ' + e.message + ' (F12 > Network bak)');
  }
}

function startGame() {
  current = [...items].sort(() => Math.random() - 0.5);
  show();
}

function show() {
  if (current.length === 1) {
    document.getElementById('game').innerHTML = `<h2>ğŸ† Åampiyon: ${current[0]} ğŸ†</h2>`;
    return;
  }
  document.getElementById('title').innerText = current.length + "'li Tur";
  document.getElementById('opt1').innerText = current[idx];
  document.getElementById('opt2').innerText = current[idx+1];
  document.getElementById('info').innerText = `EÅŸleÅŸme ${Math.floor(idx/2)+1} / ${current.length/2}`;
}

function choose(n) {
  next.push(current[idx + n]);
  idx += 2;
  if (idx >= current.length) {
    current = [...next];
    next = [];
    idx = 0;
  }
  show();
}
</script>
</body>
</html>
